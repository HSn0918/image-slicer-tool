<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>image-tool Â· å›¾ç‰‡ç­‰æ¯”ä¾‹ç¼©æ”¾</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop stop-color='%230ea5e9'/%3E%3Cstop offset='1' stop-color='%230284c7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E%3Ctext x='50%' y='55%' font-family='Manrope,Segoe UI,Arial,sans-serif' font-size='28' fill='%23fff' text-anchor='middle' font-weight='700'%3EIT%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-100 via-slate-50 to-slate-100 text-slate-900">
  <div class="max-w-6xl mx-auto grid gap-4 md:grid-cols-[240px,1fr] px-4 md:px-6 py-6">
    <aside class="bg-white/90 backdrop-blur border border-slate-200 rounded-2xl shadow-lg p-4 flex flex-col gap-3 sticky top-4 h-fit">
      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-400 to-sky-600 text-white font-black text-xl grid place-items-center shadow-lg">IT</div>
      <div>
        <p class="font-extrabold text-lg mb-1">image-tool</p>
        <p class="text-sm text-slate-600">é€‰æ‹©éœ€è¦çš„å›¾ç‰‡å·¥å…·</p>
      </div>
      <nav class="grid gap-2 text-sm font-semibold">
        <a class="flex items-center justify-between px-3 py-3 rounded-xl border border-slate-200 bg-slate-50 hover:border-sky-300 hover:bg-white transition" href="slicer.html">
          <span>å›¾ç‰‡è£å‰ªåˆ†ç‰‡</span>
          <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-blue-100 text-blue-700">ç½‘æ ¼åˆ‡ç‰‡</span>
        </a>
        <a class="flex items-center justify-between px-3 py-3 rounded-xl border border-sky-300 bg-blue-50" href="scaler.html">
          <span>å›¾ç‰‡ç­‰æ¯”ä¾‹ç¼©æ”¾</span>
          <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-blue-100 text-blue-700">å½“å‰</span>
        </a>
      </nav>
    </aside>

    <div class="space-y-4">
      <header class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-sky-400 to-sky-600 text-white font-black grid place-items-center shadow">IT</div>
        <div>
          <h1 class="text-xl font-bold tracking-tight">å›¾ç‰‡ç­‰æ¯”ä¾‹ç¼©æ”¾åˆ°æŒ‡å®šæœ€å¤§å°ºå¯¸</h1>
          <p class="text-sm text-slate-600">æŠŠå›¾ç‰‡æœ€é•¿è¾¹ç¼©æ”¾åˆ°æŒ‡å®šåƒç´ ï¼ˆé»˜è®¤ 240ï¼‰ï¼Œä¿æŒå®½é«˜æ¯”ï¼Œæ”¯æŒæ‰¹é‡ã€æ‹–æ‹½å’Œç›´æ¥ç²˜è´´ã€‚</p>
        </div>
      </header>

      <main class="space-y-4">
        <section class="bg-white/90 backdrop-blur border border-slate-200 rounded-2xl shadow p-4 space-y-3">
          <div class="flex flex-wrap items-center gap-3">
            <label class="flex items-center gap-3 px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 text-sm font-semibold">
              <span>ç›®æ ‡æœ€é•¿è¾¹(px)</span>
              <input id="sizeInput" type="number" min="1" step="1" value="240" class="w-20 border-0 bg-transparent focus:outline-none focus:ring-0 text-base text-slate-900">
            </label>
            <label for="fileInput" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-sky-500 to-sky-600 text-white font-semibold shadow hover:shadow-lg cursor-pointer">ğŸ“ é€‰æ‹©å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <input id="fileInput" type="file" accept="image/*" multiple class="hidden">
            <button id="zipBtn" class="px-4 py-2 rounded-lg bg-slate-900 text-white font-semibold shadow disabled:opacity-50" type="button" disabled>ä¸‹è½½ ZIPï¼ˆå…¨éƒ¨ï¼‰</button>
            <button id="clearBtn" class="px-4 py-2 rounded-lg border border-slate-200 text-slate-800 bg-slate-50" type="button">æ¸…ç©ºç»“æœ</button>
            <div class="text-xs text-slate-600">æˆ–ç›´æ¥æ‹–æ‹½å›¾ç‰‡/æˆªå›¾åˆ°ä¸‹é¢åŒºåŸŸï¼Œæˆ–åœ¨é¡µé¢ä¸Šç²˜è´´</div>
          </div>

          <div id="dropzone" class="border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 text-center p-8 transition" data-dropzone>
            <strong class="text-slate-800">æŠŠå›¾ç‰‡æ‹–åˆ°è¿™é‡Œ</strong><br>
            <span class="text-sm text-slate-600">æ”¯æŒæ‰¹é‡ï¼Œç²˜è´´æˆªå›¾ä¼šè‡ªåŠ¨å¤„ç†</span>
          </div>
          <div id="info" class="text-sm text-slate-600">å‡†å¤‡å°±ç»ª</div>
        </section>

        <section id="results" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3" aria-live="polite"></section>
      </main>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-4 md:px-6 pb-4 pt-3 border-t border-slate-200 text-xs text-slate-600 flex flex-wrap items-center justify-between gap-3">
    <div class="flex flex-wrap items-center gap-3">
      <span>image-tool Â· çº¯å‰ç«¯ç¦»çº¿å¯ç”¨</span>
      <span>è£å‰ªåˆ†ç‰‡ / ç­‰æ¯”ä¾‹ç¼©æ”¾</span>
      <span>Â© HSn</span>
    </div>
    <a class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold border border-blue-200" href="https://github.com/HSn0918/image-tool" target="_blank" rel="noopener">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="w-4 h-4 fill-current">
        <path d="M12 .5C5.65.5.5 5.65.5 12c0 5.1 3.29 9.42 7.86 10.95.58.1.79-.25.79-.56 0-.28-.01-1.02-.02-2-3.2.7-3.88-1.54-3.88-1.54-.53-1.34-1.3-1.7-1.3-1.7-1.06-.72.08-.71.08-.71 1.18.08 1.8 1.22 1.8 1.22 1.04 1.78 2.72 1.27 3.38.97.1-.75.41-1.27.75-1.56-2.55-.29-5.24-1.28-5.24-5.7 0-1.26.45-2.3 1.2-3.11-.12-.29-.52-1.46.11-3.06 0 0 .97-.31 3.18 1.19a11.07 11.07 0 0 1 5.8 0c2.2-1.5 3.17-1.19 3.17-1.19.64 1.6.24 2.77.12 3.06.75.81 1.2 1.85 1.2 3.1 0 4.43-2.69 5.42-5.25 5.7.42.36.8 1.06.8 2.14 0 1.54-.01 2.79-.01 3.17 0 .31.21.67.8.55A10.99 10.99 0 0 0 23.5 12C23.5 5.65 18.35.5 12 .5Z"/>
      </svg>
      GitHub æºç 
    </a>
  </footer>

  <script>
    const fileInput = document.getElementById('fileInput');
    const sizeInput = document.getElementById('sizeInput');
    const dropzone = document.getElementById('dropzone');
    const results = document.getElementById('results');
    const info = document.getElementById('info');
    const clearBtn = document.getElementById('clearBtn');
    const zipBtn = document.getElementById('zipBtn');
    const outputs = [];

    const setInfo = (text) => { info.textContent = text; };
    const buildFileName = (name, w, h) => {
      const dot = name.lastIndexOf('.');
      const base = dot > 0 ? name.slice(0, dot) : name;
      return `${base}_${w}x${h}.png`;
    };
    const flashDropzone = () => {
      dropzone.classList.add('ring-2', 'ring-sky-200');
      setTimeout(() => dropzone.classList.remove('ring-2', 'ring-sky-200'), 500);
    };
    const updateButtons = () => {
      const hasItems = outputs.length > 0;
      zipBtn.disabled = !hasItems;
      clearBtn.disabled = !hasItems;
      zipBtn.classList.toggle('opacity-50', !hasItems);
    };
    const handleFiles = (fileList) => {
      const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
      if (!files.length) { setInfo('æœªæ£€æµ‹åˆ°å›¾ç‰‡æ–‡ä»¶'); return; }
      setInfo(`æ­£åœ¨å¤„ç† ${files.length} å¼ å›¾ç‰‡â€¦`);
      files.forEach(processImage);
    };
    const processImage = (file) => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          const target = Math.max(parseInt(sizeInput.value, 10) || 240, 1);
          const scale = target / Math.max(img.width, img.height);
          const newWidth = Math.round(img.width * scale);
          const newHeight = Math.round(img.height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = newWidth;
          canvas.height = newHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, newWidth, newHeight);
          const dataUrl = canvas.toDataURL('image/png');
          addResult(file.name, dataUrl, { width: img.width, height: img.height }, { width: newWidth, height: newHeight });
          setInfo(`å·²ç”Ÿæˆ ${results.childElementCount} å¼ å›¾ç‰‡`);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    };
    const addResult = (fileName, dataUrl, original, resized) => {
      const card = document.createElement('article');
      card.className = 'bg-white border border-slate-200 rounded-xl shadow p-3 space-y-2';
      const badge = document.createElement('div');
      badge.className = 'inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold';
      const outputName = buildFileName(fileName, resized.width, resized.height);
      badge.textContent = outputName;
      card.appendChild(badge);
      const preview = document.createElement('div');
      preview.className = 'border border-slate-200 rounded-lg bg-white grid place-items-center min-h-[140px]';
      const imgEl = document.createElement('img');
      imgEl.src = dataUrl;
      imgEl.alt = 'ç¼©æ”¾åçš„å›¾ç‰‡é¢„è§ˆ';
      imgEl.className = 'max-w-full max-h-[320px] object-contain';
      preview.appendChild(imgEl);
      card.appendChild(preview);
      const meta = document.createElement('div');
      meta.className = 'flex justify-between flex-wrap gap-2 text-xs text-slate-600';
      meta.innerHTML = `<span>åŸå§‹ï¼š${original.width} Ã— ${original.height}</span><span>è¾“å‡ºï¼š${resized.width} Ã— ${resized.height}</span>`;
      card.appendChild(meta);
      const actions = document.createElement('div');
      actions.className = 'flex gap-2 flex-wrap';
      const download = document.createElement('a');
      download.className = 'px-3 py-2 rounded-lg bg-gradient-to-r from-sky-500 to-sky-600 text-white text-sm font-semibold shadow hover:shadow-lg';
      download.href = dataUrl;
      download.download = outputName;
      download.textContent = 'ä¸‹è½½ PNG';
      const copy = document.createElement('button');
      copy.type = 'button';
      copy.className = 'px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 text-sm font-semibold';
      copy.textContent = 'å¤åˆ¶å›¾ç‰‡';
      copy.addEventListener('click', async () => {
        copy.disabled = true;
        copy.textContent = 'å¤åˆ¶ä¸­â€¦';
        try {
          const blob = await (await fetch(dataUrl)).blob();
          await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
          copy.textContent = 'å·²å¤åˆ¶';
        } catch (err) {
          console.error(err);
          copy.textContent = 'å¤åˆ¶å¤±è´¥';
        } finally {
          setTimeout(() => { copy.textContent = 'å¤åˆ¶å›¾ç‰‡'; copy.disabled = false; }, 1200);
        }
      });
      actions.append(download, copy);
      card.appendChild(actions);
      results.prepend(card);
      outputs.push({ name: outputName, dataUrl });
      updateButtons();
    };

    const crcTable = (() => {
      const table = new Uint32Array(256);
      for (let i = 0; i < 256; i++) {
        let c = i;
        for (let k = 0; k < 8; k++) c = c & 1 ? 0xedb88320 ^ (c >>> 1) : c >>> 1;
        table[i] = c >>> 0;
      }
      return table;
    })();
    const crc32 = (data) => {
      let crc = 0 ^ -1;
      for (let i = 0; i < data.length; i++) crc = (crc >>> 8) ^ crcTable[(crc ^ data[i]) & 0xff];
      return (crc ^ -1) >>> 0;
    };
    const dosTimeDate = (date = new Date()) => {
      const time = (date.getHours() << 11) | (date.getMinutes() << 5) | (Math.floor(date.getSeconds() / 2));
      const dosDate = ((date.getFullYear() - 1980) << 9) | ((date.getMonth() + 1) << 5) | date.getDate();
      return { time, date: dosDate };
    };
    const concatUint8 = (arrays) => {
      const total = arrays.reduce((sum, a) => sum + a.length, 0);
      const out = new Uint8Array(total);
      let offset = 0;
      for (const arr of arrays) { out.set(arr, offset); offset += arr.length; }
      return out;
    };
    const createZip = (files) => {
      const encoder = new TextEncoder();
      const parts = [];
      const centralParts = [];
      let offset = 0;
      files.forEach(({ name, data }) => {
        const nameBytes = encoder.encode(name);
        const { time, date } = dosTimeDate();
        const crc = crc32(data);
        const size = data.length;
        const local = new DataView(new ArrayBuffer(30));
        local.setUint32(0, 0x04034b50, true);
        local.setUint16(4, 20, true);
        local.setUint16(6, 0x0800, true);
        local.setUint16(8, 0, true);
        local.setUint16(10, time, true);
        local.setUint16(12, date, true);
        local.setUint32(14, crc, true);
        local.setUint32(18, size, true);
        local.setUint32(22, size, true);
        local.setUint16(26, nameBytes.length, true);
        local.setUint16(28, 0, true);
        parts.push(new Uint8Array(local.buffer), nameBytes, data);
        const central = new DataView(new ArrayBuffer(46));
        central.setUint32(0, 0x02014b50, true);
        central.setUint16(4, 20, true);
        central.setUint16(6, 20, true);
        central.setUint16(8, 0x0800, true);
        central.setUint16(10, 0, true);
        central.setUint16(12, time, true);
        central.setUint16(14, date, true);
        central.setUint32(16, crc, true);
        central.setUint32(20, size, true);
        central.setUint32(24, size, true);
        central.setUint16(28, nameBytes.length, true);
        central.setUint16(30, 0, true);
        central.setUint16(32, 0, true);
        central.setUint16(34, 0, true);
        central.setUint16(36, 0, true);
        central.setUint32(38, 0, true);
        central.setUint32(42, offset, true);
        centralParts.push(new Uint8Array(central.buffer), nameBytes);
        offset += 30 + nameBytes.length + size;
      });
      const centralSize = centralParts.reduce((sum, p) => sum + p.length, 0);
      const eocd = new DataView(new ArrayBuffer(22));
      eocd.setUint32(0, 0x06054b50, true);
      eocd.setUint16(4, 0, true);
      eocd.setUint16(6, 0, true);
      eocd.setUint16(8, files.length, true);
      eocd.setUint16(10, files.length, true);
      eocd.setUint32(12, centralSize, true);
      eocd.setUint32(16, offset, true);
      eocd.setUint16(20, 0, true);
      const zipArray = concatUint8([...parts, ...centralParts, new Uint8Array(eocd.buffer)]);
      return new Blob([zipArray], { type: 'application/zip' });
    };
    const downloadZip = async () => {
      if (!outputs.length) return;
      zipBtn.disabled = true;
      zipBtn.textContent = 'æ‰“åŒ…ä¸­â€¦';
      try {
        const fileBuffers = [];
        for (const item of outputs) {
          const res = await fetch(item.dataUrl);
          const buf = new Uint8Array(await res.arrayBuffer());
          fileBuffers.push({ name: item.name, data: buf });
        }
        const zipBlob = createZip(fileBuffers);
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'images.zip';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('æ‰“åŒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
      } finally {
        zipBtn.textContent = 'ä¸‹è½½ ZIPï¼ˆå…¨éƒ¨ï¼‰';
        zipBtn.disabled = outputs.length === 0;
      }
    };

    document.querySelector('label[for="fileInput"]').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    ['dragenter', 'dragover'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.add('border-sky-300', 'bg-blue-50');
      });
    });
    ['dragleave', 'dragend', 'drop'].forEach(evt => {
      dropzone.addEventListener(evt, () => dropzone.classList.remove('border-sky-300', 'bg-blue-50'));
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      handleFiles(e.dataTransfer.files);
      flashDropzone();
    });
    window.addEventListener('paste', (e) => {
      const items = e.clipboardData?.items || [];
      const images = [];
      for (const item of items) {
        if (item.kind === 'file' && item.type.startsWith('image/')) {
          const file = item.getAsFile();
          if (file) images.push(file);
        }
      }
      if (images.length) {
        e.preventDefault();
        handleFiles(images);
        flashDropzone();
      }
    });
    clearBtn.addEventListener('click', () => {
      results.innerHTML = '';
      setInfo('å·²æ¸…ç©ºï¼Œç­‰å¾…æ–°å›¾ç‰‡');
      outputs.length = 0;
      updateButtons();
    });
    zipBtn.addEventListener('click', downloadZip);
    updateButtons();
  </script>
</body>
</html>
