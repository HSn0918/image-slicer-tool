<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>image-tool · 图片裁剪分片</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop stop-color='%230ea5e9'/%3E%3Cstop offset='1' stop-color='%230284c7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E%3Ctext x='50%' y='55%' font-family='Manrope,Segoe UI,Arial,sans-serif' font-size='28' fill='%23fff' text-anchor='middle' font-weight='700'%3EIT%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .grid-overlay { position: absolute; border: 1px dashed rgba(14,165,233,0.8); border-radius: 6px; pointer-events: none; z-index: 3; display: none; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.4), 0 10px 24px rgba(14,165,233,0.14); }
    .grid-line { position: absolute; background: linear-gradient(180deg, rgba(14,165,233,0) 0%, rgba(14,165,233,0.85) 50%, rgba(14,165,233,0) 100%); }
    .grid-line.h { height: 1px; left: 0; right: 0; transform: translateY(-0.5px); }
    .grid-line.v { width: 1px; top: 0; bottom: 0; transform: translateX(-0.5px); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-100 via-slate-50 to-slate-100 text-slate-900">
  <div class="max-w-6xl mx-auto grid gap-4 md:grid-cols-[240px,1fr] px-4 md:px-6 py-6">
    <aside class="bg-white/90 backdrop-blur border border-slate-200 rounded-2xl shadow-lg p-4 flex flex-col gap-3 sticky top-4 h-fit">
      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-400 to-sky-600 text-white font-black text-xl grid place-items-center shadow-lg">IT</div>
      <div>
        <p class="font-extrabold text-lg mb-1">image-tool</p>
        <p class="text-sm text-slate-600">选择需要的图片工具</p>
      </div>
      <nav class="grid gap-2 text-sm font-semibold">
        <a class="flex items-center justify-between px-3 py-3 rounded-xl border border-sky-300 bg-blue-50" href="slicer.html">
          <span>图片裁剪分片</span>
          <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-blue-100 text-blue-700">当前</span>
        </a>
        <a class="flex items-center justify-between px-3 py-3 rounded-xl border border-slate-200 bg-slate-50 hover:border-sky-300 hover:bg-white transition" href="scaler.html">
          <span>图片等比例缩放</span>
          <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-blue-100 text-blue-700">最长边</span>
        </a>
      </nav>
    </aside>

    <div class="space-y-4">
      <header class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-sky-400 to-sky-600 text-white font-black grid place-items-center shadow">IT</div>
        <div>
          <h1 class="text-xl font-bold tracking-tight">图片裁剪分片工具</h1>
          <p class="text-sm text-slate-600">单文件运行 · 拖拽/点击上传 · 自动 ZIP 打包</p>
        </div>
      </header>

      <main class="grid gap-4 lg:grid-cols-[1fr,320px] items-start">
        <section class="relative bg-white border border-slate-200 rounded-2xl shadow-lg p-3 min-h-[520px] flex items-center justify-center">
          <div class="relative w-full h-full flex items-center justify-center border border-dashed border-slate-200 rounded-xl bg-slate-50" id="dropZone">
            <input type="file" id="fileInput" accept="image/*" hidden>
            <div class="text-center text-slate-600 space-y-2 pointer-events-none" id="dropCopy">
              <h3 class="text-lg font-semibold text-slate-800">拖拽图片到此处</h3>
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">或点击选择文件</div>
              <button class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-sky-500 to-sky-600 text-white font-semibold shadow hover:shadow-lg transition" id="uploadBtn">选择图片</button>
              <div class="text-xs text-slate-500">支持 JPG · PNG · WebP · 可直接粘贴</div>
            </div>
            <img id="previewImage" alt="预览" class="max-w-full max-h-full hidden">
            <div class="grid-overlay" id="gridOverlay"></div>
          </div>
        </section>

        <aside class="space-y-3">
          <div class="bg-white border border-slate-200 rounded-2xl shadow p-4 space-y-3">
            <h3 class="font-semibold text-slate-800">比例预设</h3>
            <div class="grid grid-cols-2 gap-2" id="ratioGroup">
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:border-sky-300" data-ratio="1.7777778">16 : 9</button>
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:border-sky-300" data-ratio="1.3333333">4 : 3</button>
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:border-sky-300" data-ratio="1">1 : 1</button>
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:border-sky-300 bg-blue-50 border-blue-300" data-ratio="free" class="active">自由比例（默认全图）</button>
            </div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl shadow p-4 space-y-3">
            <h3 class="font-semibold text-slate-800">操作</h3>
            <div class="grid grid-cols-2 gap-2">
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:border-sky-300" id="fitBtn">重新适配</button>
              <button class="px-3 py-2 rounded-lg border border-slate-200 hover:border-sky-300" id="flipBtn">镜像翻转</button>
            </div>
            <div class="space-y-2">
              <button class="w-full px-4 py-2 rounded-lg bg-gradient-to-r from-sky-500 to-sky-600 text-white font-semibold shadow hover:shadow-lg transition" id="downloadBtn">导出裁剪结果为 ZIP</button>
              <button class="w-full px-4 py-2 rounded-lg bg-amber-100 text-amber-800 font-semibold border border-amber-200" id="resetBtn">重置整个画布</button>
              <div class="text-xs text-slate-600" id="status">等待图片加载... 默认全图裁成 6×4 张</div>
            </div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl shadow p-4 space-y-3">
            <h3 class="font-semibold text-slate-800">切分网格</h3>
            <div class="grid grid-cols-2 gap-2">
              <label class="text-sm text-slate-700 space-y-1">
                <span>列数</span>
                <input class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:border-sky-400 focus:ring-2 focus:ring-sky-100" type="number" id="colsInput" min="1" value="6">
              </label>
              <label class="text-sm text-slate-700 space-y-1">
                <span>行数</span>
                <input class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:border-sky-400 focus:ring-2 focus:ring-sky-100" type="number" id="rowsInput" min="1" value="4">
              </label>
            </div>
            <p class="text-xs text-slate-600">导出时按网格将当前裁剪区域分割成列×行张数</p>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl shadow p-4 space-y-2">
            <h3 class="font-semibold text-slate-800">裁剪预览</h3>
            <div class="border border-dashed border-slate-200 rounded-xl bg-slate-50 h-40 overflow-hidden preview"></div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl shadow p-4 space-y-1 text-xs text-slate-600 leading-relaxed">
            <p>• 拖拽图片到左侧画布，或点击「选择图片」。</p>
            <p>• 默认全图裁成 6×4 张，可调整比例或网格列/行数后导出。</p>
            <p>• 支持直接粘贴剪贴板图片 (Cmd/Ctrl+V)。</p>
            <p>• 选择比例后，可拖动/缩放裁剪框；滚轮可缩放，双击可放大。</p>
            <p>• 导出时会按网格生成高清 PNG 分片，并打包为 ZIP 下载。</p>
          </div>
        </aside>
      </main>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-4 md:px-6 pb-4 pt-3 border-t border-slate-200 text-xs text-slate-600 flex flex-wrap items-center justify-between gap-3">
    <div class="flex flex-wrap items-center gap-3">
      <span>image-tool · 纯前端离线可用</span>
      <span>裁剪分片 / 等比例缩放</span>
      <span>© HSn</span>
    </div>
    <a class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold border border-blue-200" href="https://github.com/HSn0918/image-tool" target="_blank" rel="noopener">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" class="w-4 h-4 fill-current">
        <path d="M12 .5C5.65.5.5 5.65.5 12c0 5.1 3.29 9.42 7.86 10.95.58.1.79-.25.79-.56 0-.28-.01-1.02-.02-2-3.2.7-3.88-1.54-3.88-1.54-.53-1.34-1.3-1.7-1.3-1.7-1.06-.72.08-.71.08-.71 1.18.08 1.8 1.22 1.8 1.22 1.04 1.78 2.72 1.27 3.38.97.1-.75.41-1.27.75-1.56-2.55-.29-5.24-1.28-5.24-5.7 0-1.26.45-2.3 1.2-3.11-.12-.29-.52-1.46.11-3.06 0 0 .97-.31 3.18 1.19a11.07 11.07 0 0 1 5.8 0c2.2-1.5 3.17-1.19 3.17-1.19.64 1.6.24 2.77.12 3.06.75.81 1.2 1.85 1.2 3.1 0 4.43-2.69 5.42-5.25 5.7.42.36.8 1.06.8 2.14 0 1.54-.01 2.79-.01 3.17 0 .31.21.67.8.55A10.99 10.99 0 0 0 23.5 12C23.5 5.65 18.35.5 12 .5Z"/>
      </svg>
      GitHub 源码
    </a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const dropCopy = document.getElementById('dropCopy');
    const previewImage = document.getElementById('previewImage');
    const ratioGroup = document.getElementById('ratioGroup');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusEl = document.getElementById('status');
    const fitBtn = document.getElementById('fitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const flipBtn = document.getElementById('flipBtn');
    const colsInput = document.getElementById('colsInput');
    const rowsInput = document.getElementById('rowsInput');
    const gridOverlay = document.getElementById('gridOverlay');

    let cropper = null;
    let objectUrl = null;
    let filenameBase = 'cropped';
    let flipped = false;

    const setStatus = (text) => { statusEl.textContent = text; };

    const destroyCropper = () => {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      if (gridOverlay) {
        gridOverlay.style.display = 'none';
        gridOverlay.innerHTML = '';
      }
    };

    const loadImage = (file) => {
      if (!file || !file.type.startsWith('image/')) {
        setStatus('请选择图片文件（JPG/PNG/WebP 等）');
        return;
      }
      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = URL.createObjectURL(file);
      filenameBase = file.name.replace(/\.[^.]+$/, '') || 'cropped';

      previewImage.classList.remove('hidden');
      dropCopy.classList.add('hidden');
      destroyCropper();
      flipped = false;

      previewImage.onload = () => {
        cropper = new Cropper(previewImage, {
          aspectRatio: getActiveRatio(),
          viewMode: 1,
          autoCropArea: 1,
          background: false,
          dragMode: 'move',
          responsive: true,
          preview: '.preview',
          ready() {
            cropper.setAspectRatio(getActiveRatio());
            const canvasData = cropper.getCanvasData();
            cropper.setCropBoxData({
              left: canvasData.left,
              top: canvasData.top,
              width: canvasData.width,
              height: canvasData.height
            });
            updateGridOverlay();
            setStatus('图片已加载，默认全图裁成网格，可调整比例或网格数量');
          },
          crop: updateGridOverlay
        });
      };
      previewImage.src = objectUrl;
    };

    const triggerDownload = (blob, name) => {
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    };

    const handleFiles = (files) => {
      if (!files || !files.length) return;
      loadImage(files[0]);
      fileInput.value = '';
    };

    const handlePaste = (event) => {
      const items = event.clipboardData && event.clipboardData.items;
      if (!items) return;
      for (const item of items) {
        if (item.type && item.type.startsWith('image/')) {
          const file = item.getAsFile();
          if (file) {
            loadImage(file);
            setStatus('已从剪贴板粘贴图片');
            return;
          }
        }
      }
      setStatus('剪贴板中未发现图片');
    };

    uploadBtn.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    ['dragenter', 'dragover'].forEach((evt) => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.classList.add('ring-2', 'ring-sky-200');
      });
    });
    ['dragleave', 'drop'].forEach((evt) => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropZone.classList.remove('ring-2', 'ring-sky-200');
      });
    });
    dropZone.addEventListener('drop', (e) => { handleFiles(e.dataTransfer.files); });
    window.addEventListener('paste', handlePaste);

    ratioGroup.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-ratio]');
      if (!btn || !cropper) return;
      const ratio = btn.dataset.ratio === 'free' ? NaN : Number(btn.dataset.ratio);
      cropper.setAspectRatio(ratio);
      ratioGroup.querySelectorAll('button').forEach((b) => {
        b.classList.remove('bg-blue-50', 'border-blue-300');
        b.classList.add('border-slate-200');
      });
      btn.classList.add('bg-blue-50', 'border-blue-300');
      setStatus(btn.dataset.ratio === 'free' ? '已切换为自由比例' : `已切换为 ${btn.textContent.trim()} 比例`);
      updateGridOverlay();
    });

    fitBtn.addEventListener('click', () => {
      if (!cropper) return setStatus('请先加载图片');
      cropper.reset();
      cropper.setAspectRatio(getActiveRatio());
      flipped = false;
      const canvasData = cropper.getCanvasData();
      cropper.setCropBoxData({ left: canvasData.left, top: canvasData.top, width: canvasData.width, height: canvasData.height });
      updateGridOverlay();
      setStatus('已重新适配并保持当前比例');
    });

    resetBtn.addEventListener('click', () => {
      destroyCropper();
      previewImage.classList.add('hidden');
      dropCopy.classList.remove('hidden');
      flipped = false;
      ratioGroup.querySelectorAll('button').forEach((b) => {
        b.classList.toggle('bg-blue-50', b.dataset.ratio === 'free');
        b.classList.toggle('border-blue-300', b.dataset.ratio === 'free');
      });
      setStatus('已重置，重新拖拽或选择图片，默认全图裁成网格');
    });

    flipBtn.addEventListener('click', () => {
      if (!cropper) return setStatus('请先加载图片');
      flipped = !flipped;
      const scaleX = flipped ? -1 : 1;
      cropper.scaleX(scaleX);
      setStatus(flipped ? '已镜像翻转' : '已恢复原始方向');
    });

    const getActiveRatio = () => {
      const activeBtn = ratioGroup.querySelector('button.bg-blue-50');
      if (!activeBtn) return NaN;
      return activeBtn.dataset.ratio === 'free' ? NaN : Number(activeBtn.dataset.ratio);
    };

    const getGridCounts = () => {
      const cols = Math.max(1, parseInt(colsInput.value, 10) || 6);
      const rows = Math.max(1, parseInt(rowsInput.value, 10) || 4);
      return { cols, rows };
    };

    const updateGridOverlay = () => {
      if (!cropper || !gridOverlay) {
        if (gridOverlay) {
          gridOverlay.style.display = 'none';
          gridOverlay.innerHTML = '';
        }
        return;
      }
      const box = cropper.getCropBoxData();
      if (!box || !box.width || !box.height) {
        gridOverlay.style.display = 'none';
        return;
      }
      const { cols, rows } = getGridCounts();
      gridOverlay.style.display = 'block';
      gridOverlay.style.left = `${box.left}px`;
      gridOverlay.style.top = `${box.top}px`;
      gridOverlay.style.width = `${box.width}px`;
      gridOverlay.style.height = `${box.height}px`;
      gridOverlay.innerHTML = '';
      for (let c = 1; c < cols; c++) {
        const vLine = document.createElement('div');
        vLine.className = 'grid-line v';
        vLine.style.left = `${(c / cols) * 100}%`;
        gridOverlay.appendChild(vLine);
      }
      for (let r = 1; r < rows; r++) {
        const hLine = document.createElement('div');
        hLine.className = 'grid-line h';
        hLine.style.top = `${(r / rows) * 100}%`;
        gridOverlay.appendChild(hLine);
      }
    };
    colsInput.addEventListener('input', updateGridOverlay);
    rowsInput.addEventListener('input', updateGridOverlay);

    downloadBtn.addEventListener('click', async () => {
      if (!cropper) {
        setStatus('请先加载并裁剪图片');
        return;
      }
      const canvas = cropper.getCroppedCanvas({ imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
      if (!canvas) {
        setStatus('请先在图片上创建裁剪区域');
        return;
      }
      const { cols, rows } = getGridCounts();
      const canvasToBlob = (cvs) => new Promise((resolve) => { cvs.toBlob(resolve, 'image/png', 0.96); });
      setStatus(`正在生成 ${cols}×${rows} 分片并打包...`);
      const zip = new JSZip();
      const tileWBase = canvas.width / cols;
      const tileHBase = canvas.height / rows;
      const tileCanvas = document.createElement('canvas');
      const ctx = tileCanvas.getContext('2d');
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const sx = Math.round(c * tileWBase);
          const sy = Math.round(r * tileHBase);
          const sw = c === cols - 1 ? canvas.width - sx : Math.round(tileWBase);
          const sh = r === rows - 1 ? canvas.height - sy : Math.round(tileHBase);
          tileCanvas.width = sw;
          tileCanvas.height = sh;
          ctx.clearRect(0, 0, sw, sh);
          ctx.drawImage(canvas, sx, sy, sw, sh, 0, 0, sw, sh);
          const blob = await canvasToBlob(tileCanvas);
          if (blob) {
            const name = `${filenameBase}-c${c + 1}-r${r + 1}.png`;
            zip.file(name, blob);
          }
        }
      }
      try {
        setStatus('正在压缩 ZIP...');
        const zipBlob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 9 } });
        const zipName = `${filenameBase}-${cols}x${rows}-grid.zip`;
        triggerDownload(zipBlob, zipName);
        setStatus('已完成导出：' + zipName);
      } catch (err) {
        console.error(err);
        setStatus('打包失败，请重试');
      }
    });
  </script>
</body>
</html>
